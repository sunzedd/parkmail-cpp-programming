name: homework_2
on:
  push:
    branches:
      - homework-2
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./homework_2

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt install valgrind clang-tidy libgtest-dev lcov

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          make

      - name: Build multiprocessed version
        run: |
          mkdir build_mp
          cd build_mp
          cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DMOODLIB_MP=ON
          make

      - name: Lint
        run: |
          clang-tidy -checks=* -header-filter=.* -p ./build/ examples/basic_example_1/src/main.c
          clang-tidy -checks=* -header-filter=.* -p ./build_mp/ examples/basic_example_1/src/main.c
          
      - name: Test (unit)
        run: |
          cd build
          ctest --output-on-failure

      - name: Test (unit) with memcheck
        run: |
          cd build
          mkdir memory_report
          cp -r ../lib/reader_utils/tests/data/ .
          valgrind --leak-check=full --show-leak-kinds=all --log-file=./memory_report/mood.txt ./lib/mood/tests/test_mood
          valgrind --leak-check=full --show-leak-kinds=all --log-file=./memory_report/moodmp.txt ./lib/mood_mp/tests/test_mood_mp
          valgrind --leak-check=full --show-leak-kinds=all --log-file=./memory_report/reader_utils.txt ./lib/reader_utils/tests/test_reader_utils
      
      - name: Test (stress / time measurement)
        run: |
          mkdir build/stress_test && mkdir build/stress_test/data
          python3 ./scripts/datagen.py positive 1 build/stress_test/data/1mb.txt
          python3 ./scripts/datagen.py positive 10 build/stress_test/data/10mb.txt
          python3 ./scripts/datagen.py positive 100 build/stress_test/data/100mb.txt
          python3 ./scripts/datagen.py positive 1000 build/stress_test/data/1gb.txt

          cd build/stress_test/
          ../../examples/measure_time/mood/measure_time_mood > time_report_mood.txt
          ../../examples/measure_time/mood_mp/measure_time_mood_mp > time_report_mood_mp.txt

      - name: Compose coverage report
        run: |
          cd build
          lcov --capture --directory . -o coverage.info
          lcov --remove coverage.info '/usr/include/*' '*/tests/*'  -o filtered_coverage.info
          genhtml -o coverage_report filtered_coverage.info

      - name: Upload memory report
        uses: actions/upload-artifact@v2
        with:
          name: report-memory
          path: ./homework_2/build/memory_report/
          if-no-files-found: error

      - name: Upload coverage report
        uses: actions/upload-artifact@v2
        with:
          name: report-coverage
          path: ./homework_2/build/coverage_report/
          if-no-files-found: error

      - name: Upload stress test report
        uses: actions/upload-artifact@v2
        with:
          name: report-time
          path: |
           ./homework_2/build/stress_test/time_report_mood.txt
           ./homework_2/build/stress_test/time_report_mood_mp.txt
